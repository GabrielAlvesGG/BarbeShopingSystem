@{
    ViewData["Title"] = "Recuperar Senha";
     Layout = "~/Views/Shared/_Layout.cshtml"; // usar layout com navbar
}

<style>
    /* ====== Fundo cinematográfico com scrim e leve blur (não afeta o conteúdo) ====== */
    .auth-bg{
        position: fixed; inset: 0;
        background: url('@Url.Content("~/Images/PhotoLogin.png")') center/cover no-repeat;
        z-index: -1; /* background atrás do navbar/layout */
        pointer-events: none;
    }
    .auth-bg::before{
        content:"";
        position: absolute; inset: 0;
        background:
            radial-gradient(90% 65% at 50% 30%, rgba(0,0,0,.25) 0%, rgba(0,0,0,.65) 70%),
            linear-gradient(180deg, rgba(0,0,0,.25) 0%, rgba(0,0,0,.68) 100%);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
    }

    /* ====== Root ====== */
    #loginRecovery{
        min-height: 100dvh;
        display: grid;
        place-items: center;
        padding: clamp(16px, 3vw, 32px);
        color: var(--text-100);
        position: relative; z-index: 1;

        /* tokens de cor: iguais à tela de Login */
        --text-100: #fff;
        --text-300: #fff;
        --text-500: #fff;
        --fg-strong: #fff;

        --bg-800: #121a2a;               /* fundo do input (fixo) */
        --border: rgba(255,255,255,.12); /* borda do input */
        --card: #0f1628;                 /* card */
        --accent: #c9a227;               /* cor de marca/destaque */
    }

    /* ====== Card premium (glass + borda em degrade) ====== */
    .auth-card{
        width: 100%; max-width: 480px;
        background:
            linear-gradient(180deg, color-mix(in srgb, var(--card, #0f1628), #000 3%), var(--card, #0f1628)) padding-box,
            linear-gradient(135deg, color-mix(in srgb, var(--accent, #c9a227), transparent 40%), color-mix(in srgb, #ffffff, transparent 92%)) border-box;
        border: 1px solid transparent;
        border-radius: 18px;
        box-shadow:
            0 30px 70px rgba(0,0,0,.45),
            inset 0 1px 0 rgba(255,255,255,.06);
        padding: clamp(20px, 3.2vw, 34px);
        transform: translateZ(0);
    }

    /* Cabeçalho: marca + título */
    .brand-mark{
        width: 64px; height: 64px; border-radius: 14px;
        display: grid; place-items: center;
        background: linear-gradient(180deg, color-mix(in srgb, var(--accent, #c9a227), transparent 80%), transparent);
        border: 1px solid color-mix(in srgb, var(--accent, #c9a227), transparent 65%);
        color: #fff;
        margin: 0 auto 10px;
        box-shadow: inset 0 1px 0 rgba(255,255,255,.15);
        font-size: 26px;
    }
    .auth-title{
        margin: 0;
        font-weight: 900;
        letter-spacing: .2px;
        color: var(--text-100);
        font-size: clamp(1.4rem, 1rem + 2.2vw, 2.1rem);
        text-align: center;
    }
    .auth-subtle{
        color: var(--text-500);
        text-align:center;
        margin-top: .35rem; margin-bottom: .75rem;
        font-size: .98rem;
    }

    /* ====== Campos ====== */
    .form-label{ color: var(--text-300); font-weight: 700; letter-spacing:.2px; }
    .input-wrap{ position: relative; }
    .input-icon{
        position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        width: 18px; height: 18px; color: var(--text-500); pointer-events: none; opacity: .9;
    }
    .input-control{
        width: 100%;
        background: var(--bg-800); /* fundo fixo */
        border: 1px solid var(--border);
        color: #fff;               /* texto branco */
        caret-color: #fff;         /* cursor branco */
        border-radius: 12px;
        padding: 12px 14px 12px 42px;
        outline: none;
        transition: border-color .15s ease, box-shadow .15s ease;
    }
    .input-control::placeholder{ color: #fff; opacity:.8; } /* placeholder branco */
    .input-control:focus,
    .input-control:focus-visible{
        background: var(--bg-800);               /* não muda no foco */
        border-color: var(--accent);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 30%, transparent);
        color: #fff; /* mantém texto branco enquanto digita */
    }

    /* Opcional: reforça a precedência quando ambas as classes existem */
    .input-control.form-control,
    .input-control.form-control:focus,
    .input-control.form-control:focus-visible{
        color: #fff;
    }

    .input-control[aria-invalid="true"]{
        border-color: color-mix(in srgb, #ef4444, transparent 10%);
        box-shadow: 0 0 0 3px color-mix(in srgb, #ef4444 22%, transparent);
    }
    .toggle-password{
        position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
        background: transparent; border: 0; color: var(--text-300);
        padding: 6px 8px; border-radius: 10px; cursor: pointer;
    }
    .toggle-password:hover{ color: var(--text-100); }
    .toggle-password:focus-visible{
        outline: 2px solid var(--accent); outline-offset: 2px;
    }

    .field-error{
        margin-top: 8px;
        color: #fff;
        background: color-mix(in srgb, #ef4444 16%, transparent);
        border: 1px solid color-mix(in srgb, #ef4444, transparent 40%);
        border-radius: 10px;
        padding: 8px 10px; font-size: .92rem;
    }

    /* ====== Botões ====== */
    .btn-brand{
        width: 100%;
        background:
            linear-gradient(180deg,
                color-mix(in srgb, var(--accent, #c9a227) 100%, transparent),
                color-mix(in srgb, var(--accent, #c9a227) 90%, transparent)
            );
        color: #fff;
        border: 1px solid var(--accent, #c9a227);
        border-radius: 12px;
        padding: 12px 16px;
        font-weight: 900; letter-spacing:.2px;
        box-shadow: 0 10px 24px color-mix(in srgb, var(--accent, #c9a227) 28%, transparent);
        transition: transform .06s ease, filter .15s ease, box-shadow .15s ease;
    }
    .btn-brand:hover{
        filter: brightness(.98);
        box-shadow: 0 12px 28px color-mix(in srgb, var(--accent, #c9a227) 34%, transparent);
    }
    .btn-brand:active{ transform: translateY(1px); }
    .btn-brand:focus-visible{ outline: 2px solid var(--accent); outline-offset: 3px; }
    .btn-brand[disabled]{ opacity: .6; cursor: not-allowed; }

    .btn-ghost{
        width: 100%;
        background: var(--bg-800);
        color: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 14px; font-weight: 700;
    }
    .btn-ghost:hover{ background: color-mix(in srgb, #fff 4%, transparent); color: #fff; }

    .btn-row{ display: grid; gap: 10px; margin-top: 14px; }

    /* ====== Spinner ====== */
    .spinner{
        display: inline-block; width: 16px; height: 16px;
        border: 2px solid color-mix(in srgb, #000 25%, transparent);
        border-top-color: currentColor;
        border-radius: 50%; animation: spin .8s linear infinite;
        vertical-align: -2px; margin-right: 8px;
    }
    @@keyframes spin { to { transform: rotate(360deg); } }

    .auth-footer{
        margin-top: 14px; text-align: center; color: var(--text-500);
        font-size: .85rem;
    }

    /* ====== Mobile ====== */
    @@media (max-width: 560px){
        .auth-card{ border-radius: 14px; }
    }

    /* ====== Blindagem de cor no autofill ====== */
    .input-control:-webkit-autofill,
    .input-control:-webkit-autofill:hover,
    .input-control:-webkit-autofill:focus{
        -webkit-text-fill-color: #fff !important;
        caret-color: #fff;
        -webkit-box-shadow: 0 0 0 1000px var(--bg-800) inset !important;
        box-shadow: 0 0 0 1000px var(--bg-800) inset !important;
        transition: background-color 9999s ease-out, color 9999s ease-out;
    }
    input.input-control:-moz-ui-invalid { box-shadow: none; }

    /* SweetAlert2: botão confirmar (modal de sucesso do envio de e-mail) */
    .swal2-confirm-green.swal2-styled{
        background-color: #16a34a !important; /* verde */
        border: 1px solid #16a34a !important;
        color: #fff !important;               /* texto branco */
    }
    .swal2-confirm-green.swal2-styled:hover{
        filter: brightness(.98);
    }
    .swal2-confirm-green.swal2-styled:focus-visible{
        outline: 2px solid #16a34a;
        outline-offset: 2px;
        box-shadow: 0 0 0 3px color-mix(in srgb, #16a34a 30%, transparent);
    }
</style>

<!-- Background (fica por trás de tudo) -->
<div class="auth-bg" aria-hidden="true"></div>

<div id="loginRecovery">
    <div class="auth-card">
        <header class="text-center mb-3">
            <div class="brand-mark">✂️</div>
            <h1 class="auth-title">Recuperar senha</h1>
            <p class="auth-subtle">Vamos te ajudar a voltar ao seu acesso</p>
        </header>

        <!-- FORM 1: Solicitar e-mail (quando NÃO há token válido) -->
        <form v-show="!showFormRecovery" novalidate v-on:keyup.enter="recoveryLogin">
            <div class="mb-3">
                <label for="emailInput" class="form-label">Login (e-mail)</label>
                <div class="input-wrap">
                    <svg class="input-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5Z"/>
                    </svg>
                    <input
                        id="emailInput"
                        type="email"
                        v-model="loginRecoveryForm.login"
                        class="input-control form-control"
                        placeholder="seu@email.com"
                        autocomplete="username"
                        :aria-invalid="messages.alertLoginInvalidade ? 'true' : 'false'"
                        :aria-describedby="messages.alertLoginInvalidade ? 'emailError' : null">
                </div>
                <div id="emailError" class="field-error" v-show="messages.alertLoginInvalidade" role="alert" aria-live="polite">
                    O campo de login está inválido.
                </div>
            </div>

            <div class="text-center">
                <button type="button"
                        class="btn btn-brand btn-lg"
                        :disabled="isLoading"
                        :aria-busy="isLoading ? 'true' : 'false'"
                        v-on:Click="recoveryLogin">
                    <span v-if="isLoading" class="spinner" aria-hidden="true"></span>
                    Enviar solicitação
                </button>
            </div>

            <div class="btn-row">
                <a href="/Login/Login" class="btn btn-ghost btn-lg">Voltar ao login</a>
            </div>

            <div class="auth-footer">© 2025 • BarberShopSystem</div>
        </form>

        <!-- FORM 2: Redefinição (quando token válido) -->
        <form v-show="showFormRecovery" novalidate v-on:keyup.enter="resetPassword">
            <div class="mb-3">
                <label for="newPassword" class="form-label">Nova senha</label>
                <div class="input-wrap">
                    <svg class="input-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path fill="currentColor" d="M17 8h-1V6a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-6 8v-2a1 1 0 1 1 2 0v2a1 1 0 1 1-2 0ZM9 8V6a3 3 0 0 1 6 0v2Z"/>
                    </svg>
                    <input
                        id="newPassword"
                        :type="showPassword1 ? 'text' : 'password'"
                        v-model="loginRecoveryForm.password"
                        class="input-control form-control"
                        placeholder="Crie uma nova senha"
                        autocomplete="new-password"
                        :aria-invalid="messages.alertPasswordInvalidade ? 'true' : 'false'"
                        :aria-describedby="messages.alertPasswordInvalidade ? 'passwordError' : null">
                    <button type="button"
                            class="toggle-password"
                            :aria-pressed="showPassword1 ? 'true' : 'false'"
                            aria-label="Mostrar ou ocultar nova senha"
                            v-on:click="showPassword1 = !showPassword1">
                        <svg v-if="!showPassword1" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7Zm0 12a5 5 0 1 1 5-5 5 5 0 0 1-5 5Z"/>
                        </svg>
                        <svg v-else width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M2 5.27 3.28 4 20 20.72 18.73 22l-2.1-2.1A12.5 12.5 0 0 1 12 19c-7 0-10-7-10-7a21.23 21.23 0 0 1 5-6.1L2 5.27ZM12 7a5 5 0 0 1 5 5 4.94 4.94 0 0 1-.45 2.07L14.9 12.42A2.99 2.99 0 0 0 12 9a2.9 2.9 0 0 0-1.2.26L9.5 7.96A5 5 0 0 1 12 7Z"/>
                        </svg>
                    </button>
                </div>
                <div id="passwordError" class="field-error" v-show="messages.alertPasswordInvalidade" role="alert" aria-live="polite">
                    A senha está inválida.
                </div>
            </div>

            <div class="mb-3">
                <label for="repeatPassword" class="form-label">Repita a senha</label>
                <div class="input-wrap">
                    <svg class="input-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path fill="currentColor" d="M17 8h-1V6a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-6 8v-2a1 1 0 1 1 2 0v2a1 1 0 1 1-2 0ZM9 8V6a3 3 0 0 1 6 0v2Z"/>
                    </svg>
                    <input
                        id="repeatPassword"
                        :type="showPassword2 ? 'text' : 'password'"
                        v-model="loginRecoveryForm.repeatPassword"
                        class="input-control form-control"
                        placeholder="Repita a nova senha"
                        autocomplete="new-password"
                        :aria-invalid="messages.alertRepeatpasswordInvalidade ? 'true' : 'false'"
                        :aria-describedby="messages.alertRepeatpasswordInvalidade ? 'repeatPasswordError' : null">
                    <button type="button"
                            class="toggle-password"
                            :aria-pressed="showPassword2 ? 'true' : 'false'"
                            aria-label="Mostrar ou ocultar repetição de senha"
                            v-on:click="showPassword2 = !showPassword2">
                        <svg v-if="!showPassword2" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7Zm0 12a5 5 0 1 1 5-5 5 5 0 0 1-5 5Z"/>
                        </svg>
                        <svg v-else width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M2 5.27 3.28 4 20 20.72 18.73 22l-2.1-2.1A12.5 12.5 0 0 1 12 19c-7 0-10-7-10-7a21.23 21.23 0 0 1 5-6.1L2 5.27ZM12 7a5 5 0 0 1 5 5 4.94 4.94 0 0 1-.45 2.07L14.9 12.42A2.99 2.99 0 0 0 12 9a2.9 2.9 0 0 0-1.2.26L9.5 7.96A5 5 0 0 1 12 7Z"/>
                        </svg>
                    </button>
                </div>
                <div id="repeatPasswordError" class="field-error" v-show="messages.alertRepeatpasswordInvalidade" role="alert" aria-live="polite">
                    A senha não está igual!
                </div>
            </div>

            <div class="text-center">
                <button type="button"
                        class="btn btn-brand btn-lg"
                        :disabled="isLoading"
                        :aria-busy="isLoading ? 'true' : 'false'"
                        v-on:Click="resetPassword">
                    <span v-if="isLoading" class="spinner" aria-hidden="true"></span>
                    Redefinir senha
                </button>
            </div>

            <div class="btn-row">
                <a href="/Login/Login" class="btn btn-ghost btn-lg">Voltar ao login</a>
            </div>

            <div class="auth-footer">© 2025 • BarberShopSystem</div>
        </form>
    </div>
</div>

<script src="~/lib/vue/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    var loginRecovery = new Vue({
        el: '#loginRecovery',
        data() {
            return {
                loginRecoveryForm: {
                    login: "",
                    password:"",
                    repeatPassword:"",
                },
                messages: {
                    alertLoginInvalidade: false,
                    alertPasswordInvalidade: false,
                    alertRepeatpasswordInvalidade: false
                },
                queryString:{
                    token : ''
                },
                showFormRecovery: false,
                isLoading: false,
                showPassword1: false,
                showPassword2: false
            };
        },
        methods: {
            recoveryLogin() {
                this.resetProptsForms();
                if (this.validateForm()) return;

                this.isLoading = true;
                const login = this.loginRecoveryForm.login;

                axios.post('/Login/SendRecoveryCode', login, {
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if (response.data){
                        Swal && Swal.fire({
                            title: 'Email enviado!',
                            text: 'O seu email de confirmação foi enviado com sucesso!',
                            icon: 'success',
                            confirmButtonText: 'Ok',
                            customClass: { confirmButton: 'swal2-confirm-green' },
                            footer: 'Verifique seu e-mail para atualizar a senha.'
                        });
                    } else {
                        Swal && Swal.fire({
                            title: 'Login inválido!',
                            text: 'O seu login está incorreto!',
                            icon: 'error',
                            confirmButtonText: 'Ok',
                            customClass: { confirmButton: 'swal2-confirm-green' },
                            footer: 'Verifique os dados preenchidos'
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro ao enviar solicitação de recuperação:', error);
                })
                .finally(() => { this.isLoading = false; });
            },
            validateForm() {
                let formInValidate = false;
                if (this.loginRecoveryForm.login === "") {
                    this.messages.alertLoginInvalidade = true;
                    formInValidate = true;
                }
                return formInValidate;
            },
            resetProptsForms() {
                this.messages.alertLoginInvalidade = false;
                this.messages.alertPasswordInvalidade = false;
                this.messages.alertRepeatpasswordInvalidade = false;
            },
            getQueryString(){
                let urlParams = new URLSearchParams(window.location.search);
                if(urlParams.has('token')){
                    this.queryString.token = urlParams.get('token');
                    this.validateToken(this.queryString.token);
                }
            },
            validateToken(token){
                if(!token){ this.showFormRecovery = false; return; }

                axios.post('/Login/ValidateToken', token, {
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if(response.data){
                        this.showFormRecovery = true;
                    } else {
                        this.showFormRecovery = false;
                        if(this.queryString.token){
                            Swal && Swal.fire({
                                title: 'Token inválido!',
                                text: 'Esse token já foi utilizado ou expirou.',
                                icon: 'error',
                                confirmButtonText: 'Ok',
                                customClass: { confirmButton: 'swal2-confirm-green' },
                                footer: 'Peça uma nova solicitação de senha.'
                            });
                        }
                        this.queryString.token = '';
                    }
                })
                .catch(error => {
                    console.error('Erro ao validar token:', error);
                });
            },
            resetPassword(){
                if(this.validateRepeatPassword()){
                    this.isLoading = true;
                    var resetPassword =  {
                        password: this.loginRecoveryForm.password,
                        token: this.queryString.token
                    };

                    axios.post('/Login/ChangePassword', resetPassword, {
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => {
                        Swal && Swal.fire({
                            title: 'Senha alterada com sucesso!',
                            text: 'Sua senha foi alterada com sucesso!',
                            icon: 'success',
                            confirmButtonText: 'Ok',
                            footer: 'Tente logar usando a nova senha.'
                        });
                    })
                    .catch(error => {
                        console.error('Erro ao redefinir senha:', error);
                    })
                    .finally(() => {
                        this.isLoading = false;
                        setTimeout(() => { window.location.href = "/Login/Login"; }, 3000);
                    });
                }
            },
            validateRepeatPassword(){
                const ok = this.loginRecoveryForm.password === this.loginRecoveryForm.repeatPassword &&
                           this.loginRecoveryForm.password !== "" &&
                           this.loginRecoveryForm.repeatPassword !== "";
                this.messages.alertPasswordInvalidade = !ok;
                this.messages.alertRepeatpasswordInvalidade = !ok;
                return ok;
            }
        },
        mounted(){
            this.getQueryString();
        },
    })
</script>
